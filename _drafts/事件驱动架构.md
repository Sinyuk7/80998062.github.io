# äº‹ä»¶é©±åŠ¨æ¶æ„



å…ˆæ¥è¯´è¯´**EventBus**,ç›¸ä¿¡åŸºæœ¬ä¸Šæ¯ä¸ªäººéƒ½ç”¨è¿‡å®ƒ,

å› ä¸ºè¢«è®¾è®¡çš„ç®€å•æ˜“ç”¨,çœ‹ä¸‹æ–‡æ¡£æˆ‘ä»¬å°±å¯ä»¥å¾ˆå¿«ä¸Šæ‰‹.

è™½ç„¶æ„Ÿè§‰ä¹‹å‰ä¸€ç›´æ¼æ‰äº†ä¸€äº›ä¸œè¥¿:





ä¹‹å‰æˆ‘å¯¹äº‹ä»¶é©±åŠ¨,äº‹ä»¶æ€»çº¿è¿™äº›ä¸œè¥¿ä¹Ÿæ²¡æœ‰ä¸€ä¸ªæ¸…æ™°çš„æ¦‚å¿µ.

çœ‹åˆ°å…³äº**EventBus**çš„ä½¿ç”¨åŸºæœ¬éƒ½æ˜¯åˆ†ææºç ,ç„¶åæ˜¯*hello world*ç±»å‹çš„**demo**

- æ¯”å¦‚åœ¨`Fragment`å’Œ`Activity`ä¹‹å‰ä¼ é€’äº‹ä»¶(ä¸è¿‡æ˜¯å‡å°‘ä¸€ç‚¹æ ·æ¿ä»£ç :as Callback or Lisenter)
- æ¯”å¦‚åœ¨ä¸€äº›éš¾ä»¥æ§åˆ¶UIçš„åœ°æ–¹å‘é€äº‹ä»¶,ç„¶ååœ¨Viewå±‚æ›´æ–°(å¾€å¾€æ˜¯**Controller**,**Presenter** ,**Adapter**é‡Œé¢)



ç„¶åå…³äºè§£è€¦å…³äºæ¨¡å—åŒ–çš„è¯é¢˜,è€ç”Ÿå¸¸è°ˆäº†

ä¸»è¦è¿˜æ˜¯å› ä¸ºä»£ç æ˜¯å†™ç»™äººçœ‹çš„...è‡ªå·±éƒ½ä¸æƒ³ç¢°äº†å°±tmå°´å°¬äº†

åƒæˆ‘æ¯æ¬¡é¢å¯¹ä¸€ä¸ªæ–°éœ€æ±‚,éƒ½åœ¨æƒ³ä¹‹å‰è‡ªå·±å†™çš„æ˜¯ä»€ä¹ˆåƒåœ¾ä»£ç ?



ä¸ºä»€ä¹ˆæˆ‘è¦æŠŠè¿™æ®µä»£ç åœ¨ä¸åŒçš„åœ°æ–¹å†™ä¸¤é?

ä¸ºä»€ä¹ˆ10Wè¡Œçš„*code*,ä¼šæœ‰3Wè¡Œçš„*refactoring*å’Œ*rewritting*?

>  å½“ç„¶è¿˜æœ‰6Wè¡Œæ˜¯*.xml*,ğŸ˜„



ä¹‹å‰åœ¨çœ‹**[Android-CleanArchitecture](https://github.com/android10/Android-CleanArchitecture)**çš„æ—¶å€™å°±å‘ç°é‡Œé¢æœ‰**[ThreadPoolExecutor](https://github.com/android10/Android-CleanArchitecture/blob/master/data/src/main/java/com/fernandocejas/android10/sample/data/executor/JobExecutor.java)**

å½“æ—¶ä¸€è„¸æ‡µé€¼,å†çœ‹äº†ä¸€é**EventBus**çš„æ–‡æ¡£,ç„¶åç®€å•äº†è§£äº†ä¸€ä¸‹äº‹ä»¶é©±åŠ¨ç¼–ç¨‹

> å‘ç°ä¹‹å‰æˆ‘å¯èƒ½ä¸Šäº†ä¸€ä¸ªå‡çš„**EventBus**



---



äº‹ä»¶é©±åŠ¨ç¼–ç¨‹èŒƒå¼å…¶å®å¾ˆå¸¸è§...éšæ‰‹ç”»äº†ä¸€ä¸ªæ€ç»´å¯¼å›¾

- å¤–é¢çš„æ˜¯è§†å›¾å±‚

  ç”¨æˆ·çš„ä¸åŒæ“ä½œ(æ¯”å¦‚*ä¸Šä¸Šä¸‹ä¸‹å·¦å·¦å³å³ABAB*)å¯ä»¥ä»£è¡¨åŒä¸€ä¸ªäº‹ä»¶:èƒŒåçš„ä¸šåŠ¡é€»è¾‘,å‘é€å‡ºå»ç„¶åç­‰å¾…å›è°ƒä½œå‡ºå“åº”.

- ä¸­é—´çš„æ˜¯äº‹ä»¶å¤„ç†å™¨.

è®¸å¤šæƒ…å†µä¸‹ï¼Œäº‹ä»¶å¤„ç†å™¨å¯ä»¥è‡ªå·±å¤„ç†äº‹ä»¶ï¼Œå› æ­¤ä¹Ÿå¯èƒ½å‘é€ä¸€ä¸ªäº‹ä»¶(å›è°ƒ)

å®ƒå¯èƒ½æ˜¯ä¸€ä¸ªmain loop,ä¸åœå¾ªç¯åœ°æ£€æµ‹å’Œå¤„ç†äº‹ä»¶(æ„Ÿè§‰è¿™æ ·è‚¯å®šæ˜¯ä¸å¥½çš„)

ä¹Ÿå¯èƒ½ä¼šæ˜¯ä¸€ä¸ªExecutor,æ³¨å…¥ä¸åŒçš„Thread,å¤„ç†å’Œå‘é€äº‹ä»¶ 



ä¸çŸ¥é“è¿™æ ·è¯´å¯¹ä¸å¯¹,ä¸åŒäºè½¯ä»¶æ¶æ„(ä¸ºäº†è§£è€¦å’Œæ¨¡å—åŒ–),äº‹ä»¶é©±åŠ¨ç¨‹åºè®¾è®¡ç€é‡äºå¼¹æ€§å’Œå¼‚æ­¥åŒ–,å¹¶ä¸”å°½å¯èƒ½çš„***modeless***(ä¸ç”¨å¼ºåˆ¶ç­‰å¾…å›è°ƒç„¶åä½œå‡ºå“åº”)



ä¸è¿‡æ—¢ç„¶ç”¨**EventBus**,å°±ä¸ç”¨å…³å¿ƒé‚£ä¹ˆå¤šäº†...

å†™ä¸€ä¸ªç±»åŒæ—¶ä½œä¸º`Observer`å’Œ`Subscriber`,åœ¨é‚£é‡Œè®¢é˜…å’Œå‘é€äº‹ä»¶å°±å¥½äº†



ä¸‹é¢è¦è®²ä¸€ç‚¹**EventBus**äº†



ä¸è¡Œä¸è¡Œ,æ‰“å­—å·²ç»è¯´ä¸æ¸…æ¥šäº† æˆ‘è¦ä¸Šä»£ç äº†

>  ä¸€ä¸ªå‘é€è¯„è®ºçš„åŠŸèƒ½

```java
public class CommentBus implements CommentContact.Bus {
    @NotNull
    private final RemoteDataSource remoteDataSource;
    private final CompositeSubscription mCompositeSubscription;

    @Inject
    public CommentBus(@NotNull RemoteDataSource remoteDataSource) {
        this.remoteDataSource = remoteDataSource;
        mCompositeSubscription = new CompositeSubscription();
    }

    @Inject
    @Override
    public void register() {
        EventBus.getDefault().register(this);
    }

    @Override
    public void unregister() {
        if (EventBus.getDefault().isRegistered(this))
            EventBus.getDefault().unregister(this);
        if (!mCompositeSubscription.isUnsubscribed())
            mCompositeSubscription.unsubscribe();
    }


    @Subscribe(threadMode = ThreadMode.MAIN)
    public void onPostComment(final CommentPostEvent event) {
        postComment(event.getExecutionScope());
    }

    @Override
    public void postComment(Object scope) {
        mCompositeSubscription.add(remoteDataSource.postComment()
                .subscribe(new Observer<Comment>() {
                  	//...skip
                    @Override
                    public void onError(Throwable e) {
                        CommentPostCallback callback = new CommentPostCallback(e);
                        callback.setExecutionScope(scope);
                        EventBus.getDefault().post(callback);
                    }

                    @Override
                    public void onNext(Comment comment) {
                        CommentPostCallback callback = new CommentPostCallback(comment);
                        callback.setExecutionScope(scope);
                        EventBus.getDefault().post(callback);
                    }
                }));
    }
}
```

`CommentBus`,åœ¨éœ€è¦çš„æ—¶å€™æ³¨å…¥,å®ƒçš„`Scope`ä¸€èˆ¬æ˜¯å’Œ`Activity`/`Fragment`ç›¸åŒ,å› ä¸ºæˆ‘ä»¬å¹¶ä¸æ˜¯ä»»ä½•æ—¶å€™éƒ½éœ€è¦ç›‘å¬æ­¤ç±»äº‹ä»¶.

ç”¨äº†**Dagger2**ä¹‹å æ„Ÿè§‰å¾ˆå¥½çš„å°±æ˜¯å¼ºè°ƒäº†æ¯ä¸ªå®ä¾‹çš„`Scope`,è€Œæˆ‘ä»¬ä¹Ÿæ˜¯éœ€è¦ä¸€ä¸ªä¸ª`Context`æ‰èƒ½ç»´æŒå„ç§ç»„ä»¶çš„æ­£å¸¸å·¥ä½œ,æ®Šé€”åŒå½’

æ¯”å¦‚ä½ åœ¨**Event**ä¸­ä¹ŸåŠ å…¥å®ƒçš„`Scope`:

```java
public class CommentPostEvent implements HasExecutionScope {
  	private Object executionScope;
  
    @Override
    public Object getExecutionScope() {
        return executionScope;
    }

    @Override
    public void setExecutionScope(Object executionScope) {
        this.executionScope = executionScope;
    }
}
```

### HasExecutionScope

ç‚’é¸¡æœ‰ç”¨çš„ä¸€ä¸ªæ¥å£,å› ä¸ºè®¢é˜…å¯ä»¥å˜å¾—å¾ˆæ··ä¹±å’Œéš¾ä»¥å¤„ç†

æ¯”å¦‚é¡µé¢ABCDéƒ½è®¢é˜…äº†äº‹ä»¶E,é¡µé¢ABCDçš„å®ä¾‹éƒ½å­˜åœ¨äºæ ˆä¸­(å½“ç„¶è¿™ç§æƒ…å†µæ¯”è¾ƒå°‘,Appçš„é¡µé¢æ·±åº¦æœ‰é™)ç„¶åä½ åªæƒ³é¡µé¢Aå“åº”å®ƒè‡ªå·±å‘å‡ºäº‹ä»¶çš„å›è°ƒ.

ä¹‹å‰ä¸çŸ¥é“è¿™ä¸ªæ¥å£çš„æ—¶å€™,æˆ‘ä¼šè‡ªå·±å‚»ä¹ä¹åœ°ç»™EventåŠ ä¸€ä¸ªTAG...

ç°åœ¨åªè¦åœ¨å‘é€äº‹ä»¶çš„æ—¶å€™è®¾ç½®ä¸€ä¸ªScope

```java
CommentPostEvent event = new CommentPostEvent();
event.setExecutionScope(this);
EventBus.getDefault().post(event);
```

ç„¶ååœ¨Subscriberé‡Œé¢åˆ¤æ–­æ˜¯å¦æ˜¯åŒä¸€ä¸ªScope

```java
@Subscribe(threadMode = ThreadMode.MAIN)
public void onPostCommentCallback(CommentPostCallback callback) {
    if (PostCommentActivity.class.equals(callback.getExecutionScope())) {
       // do something cool
    }
}
```
### Priorities

å½“ç„¶è®¢é˜…è¿˜å¯ä»¥æœ‰ä¼˜å…ˆçº§

```java
@Subscribe(priority = 1);
public void onEvent(CommentPostCallback callback) {
    ...
}
```

å¤§å¤šæ•°æƒ…å†µä¸‹æˆ‘ä»¬éƒ½ä¸ä¼šç”¨åˆ°Eventçš„ä¼˜å…ˆçº§æˆ–è€…äº‹ä»¶çš„å–æ¶ˆå‘é€,ä½†æ˜¯æœ‰äº›æ—¶å€™å®ƒè¿˜æ˜¯èƒ½æ´¾ä¸Šç”¨åœº.

æ¯”å¦‚ä¸€ä¸ªäº‹ä»¶åœ¨å‰å°æˆ–è€…åå°çš„æ—¶å€™éœ€è¦æœ‰ä¸åŒçš„UIå¤„ç†é€»è¾‘

æ¯”å¦‚åœ¨é«˜ä¼˜å…ˆçº§çš„Subscriberå¤„ç†äº‹ä»¶çš„æ—¶å€™å–æ¶ˆå‘ä¸‹å‘é€,é€šè¿‡è°ƒç”¨`cancelEventDelivery(ObjectÂ event)`

> æ³¨æ„: åœ¨**åŒä¸€ä¸ª**å‘é€äº‹ä»¶çš„çº¿ç¨‹ä¸‹,è®¾ç½®ä¼˜å…ˆçº§æ‰ä¼šç”Ÿæ•ˆ(é»˜è®¤ä¸º0)



### FAQs

>  *ä½†è¿˜æ˜¯æœ‰å¥½å¤šä¸ªä¸ºä»€ä¹ˆ.æœ‰**dalao**å¸¦æˆ‘ä¸Šè½¦å—...æ»´,å­¦ç”Ÿå¡* ğŸšŒ

**Q1**:

å› ä¸º**EventBus**åªæ˜¯ä¸€ä¸ªç»„ä»¶ä¹‹é—´è§£è€¦çš„å·¥å…·,æˆ‘ä»¬åœ¨å¼€å‘ä¸­è¿˜æ˜¯è¦é€‰æ‹©åˆé€‚çš„è½¯ä»¶æ¶æ„(æ¯”å¦‚**MVP**).

é‚£ä¹ˆé—®é¢˜æ¥äº†,åœ¨**View**,**Usecase**,**Data**ä¸‰ä¸ªå±‚æ¬¡,åº”è¯¥ç”¨ä¸€ä¸ªäº‹ä»¶æ€»çº¿å‘¢è¿˜æ˜¯å¤šä¸ª?

å¦‚æœæ˜¯ä¸€ä¸ª,å¤æ‚åº¦æ˜æ˜¾ä¼šå¢åŠ å¾ˆå¤š;å¦‚æœæ˜¯å¤šä¸ª,å¯èƒ½æˆ‘ä»¬åœ¨ä¸åŒçš„å±‚çº§ä¹‹é—´è¦é‡å¤å‘é€å¾ˆå¤šç›¸åŒçš„äº‹ä»¶.

**Q1.1**:

ç„¶åè¿˜è¦é¢ä¸´å¦å¤–ä¸€ä¸ªé—®é¢˜,å½“é¡¹ç›®é‡Œé¢éƒ½æ˜¯å„ç§**Event**çš„æ—¶å€™,æ€ä¹ˆæ›´å¥½åœ°ç®¡ç†æ··ä¹±çš„ä»£ç ?

>  *If any one give me a working example much appreciated*,*thanks in advance*

**Q2**:

æ—¢ç„¶æœ‰äº†äº‹ä»¶é©±åŠ¨,é‚£ä¹ˆæ˜¯ä¸æ˜¯å°±ä¸ç”¨**Presenter**äº†.å› ä¸ºPresenteræœ‰æ—¶å€™è¿˜æ˜¯ä¼šéš¾ä»¥å¤ç”¨,é¿å…ä¸äº†ä¸€å †æ ·æ¿ä»£ç æˆ–è€…ç©ºæ¥å£.

å½“ç„¶ä½ å¯ä»¥æŠŠPresenterçš„åŠŸèƒ½å†ç»†åˆ†,åœ¨ä¸€ä¸ªé¡µé¢æ³¨å…¥å¤šä¸ªPresenter.ä½†æ˜¯æ„Ÿè§‰æ²¡æœ‰ç”¨Post Eventçš„æ–¹å¼æ¥çš„é…·ç‚«,è€Œä¸”å¯ä»¥æ›´å®¹æ˜“åä½œå¼€å‘ä¸Šå±‚çš„ä»£ç .



> ä½ åœ¨onEvent()åšæŸç§åˆå§‹åŒ–çš„è¯
>
> å½“acitivityé‡å»ºçš„æ—¶å€™Â ä¸èƒ½retain state

